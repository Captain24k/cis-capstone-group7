<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title>Login</title>

	<style>
		body { font-family: Arial; background:#f4f4f4; margin:0; }
		.box { width:420px; margin:60px auto; background:#fff; padding:20px; border:1px solid #ddd; border-radius:6px; }
		h2 { margin-top:0; }
		label { display:block; margin-top:12px; font-weight:bold; }
		input { width:100%; box-sizing:border-box; padding:8px; margin-top:6px; border:1px solid #bbb; border-radius:4px; }
		button { margin-top:15px; padding:8px 12px; border:none; border-radius:4px; cursor:pointer; background:#2d7ef7; color:#fff; }
		.note { font-size:12px; color:#555; margin-bottom:10px; }
		#msg { margin-top:12px; min-height:18px; font-size:14px; }
	</style>

	<script>
		function setAuth(token, role) {
			localStorage.setItem("token", token);
			localStorage.setItem("role", role);
		}

		function showMsg(text, color) {
			var msg = document.getElementById("msg");
			msg.style.color = color || "red";
			msg.innerText = text || "";
		}

		function apiBase() {
			
			return window.location.origin;
		}

		async function safeJsonOrText(res) {
			var ct = (res.headers.get("content-type") || "").toLowerCase();
			try {
				if (ct.indexOf("application/json") !== -1) {
					return await res.json();
				}
				var txt = await res.text();
				return { ok: res.ok, message: txt || ("HTTP " + res.status) };
			} catch (e) {
				// If parsing fails, return a useful fallback
				return { ok: res.ok, message: "Response parse error (HTTP " + res.status + ")" };
			}
		}

		async function apiFetch(path, options) {
			
			var controller = new AbortController();
			var t = setTimeout(function () { controller.abort(); }, 10000);

			try {
				var res = await fetch(apiBase() + path, Object.assign({}, options || {}, { signal: controller.signal }));
				var data = await safeJsonOrText(res);
				return { res: res, data: data };
			} finally {
				clearTimeout(t);
			}
		}

		window.onload = function () {
			
			if (window.location.protocol === "file:") {
				showMsg("Open this page through the Node server (example: http://localhost:3000), not by double-clicking the file.", "red");
			}
		};

		async function LoginHandler() {
			var user = document.getElementById("txtId").value.trim();
			var pass = document.getElementById("txtPass").value.trim();

			showMsg("");

			if (user === "" || pass === "") {
				showMsg("Please enter ID and password.", "red");
				return;
			}

			try {
				var result = await apiFetch("/api/login", {
					method: "POST",
					headers: { "Content-Type": "application/json" },
					body: JSON.stringify({ user: user, password: pass })
				});

				var data = result.data || {};

				if (!result.res.ok || !data.ok) {
					showMsg((data && (data.error || data.message)) || ("HTTP " + result.res.status), "red");
					return;
				}

				if (!data.token || !data.role) {
					showMsg("Login response missing token/role. Check server response.", "red");
					return;
				}

				setAuth(data.token, data.role);

				if (data.role === "emp") {
					window.location.href = "employee.html";
				} else if (data.role === "manager") {
					window.location.href = "manager.html";
				} else {
					showMsg("Unknown role in database.", "red");
				}
			} catch (e) {
				if (e && e.name === "AbortError") {
					showMsg("Request timed out. Is the Node server running?", "red");
					return;
				}
				showMsg("Connection error: " + (e && e.message ? e.message : "Unknown error"), "red");
			}
		}
	</script>
</head>

<body>
	<div class="box">
		<h2>Login</h2>

		<p class="note">
			Use your DB users table accounts.
		</p>

		<label for="txtId">User</label>
		<input id="txtId" type="text" placeholder="Enter user" />

		<label for="txtPass">Password</label>
		<input id="txtPass" type="password" placeholder="Enter password" />

		<button onclick="LoginHandler()">Login</button>

		<div id="msg"></div>
	</div>
</body>
</html>